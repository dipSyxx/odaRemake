generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum CartStatus {
  DRAFT
  ACTIVE
  SUBMITTED
  CANCELLED
}

enum DiscountSource {
  CAMPAIGN
  UNKNOWN
}

enum PromotionDisplayStyle {
  REGULAR_DISCOUNT
  UNKNOWN
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  phone     String?  @unique
  address   String?
  passwordHash  String?
  carts     Cart[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cart {
  id          String     @id @default(cuid())
  user        User?      @relation(fields: [userId], references: [id])
  userId      String?
  status      CartStatus @default(DRAFT)
  currency    String     @default("NOK")
  totalAmount Decimal    @default(0) @db.Decimal(12, 2)
  items       CartItem[]
  submittedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model CartItem {
  id        String   @id @default(cuid())
  cart      Cart     @relation(fields: [cartId], references: [id])
  cartId    String
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  quantity  Int      @default(1)
  unitPrice Decimal  @db.Decimal(10, 2)
  currency  String   @default("NOK")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
}

model Product {
  id                              Int                 @id
  fullName                        String
  brand                           String?
  brandExternalId                 Int?
  name                            String
  nameExtra                       String?
  frontUrl                        String
  absoluteUrl                     String
  grossPrice                      Decimal             @db.Decimal(10, 2)
  grossUnitPrice                  Decimal             @db.Decimal(10, 2)
  unitPriceQuantityAbbreviation   String?
  unitPriceQuantityName           String?
  currency                        String              @default("NOK")
  isAvailable                     Boolean             @default(true)
  availabilityCode                String              @default("available")
  availabilityDescription         String?
  availabilityDescriptionShort    String?
  metadata                        Json?
  isExemptFromThirdPartyMarketing Boolean             @default(false)
  bonusInfo                       Json?
  images                          ProductImage[]
  classifiers                     ProductClassifier[]
  discount                        Discount?
  promotions                      Promotion[]
  cartItems                       CartItem[]
  createdAt                       DateTime            @default(now())
  updatedAt                       DateTime            @updatedAt
}

model ProductImage {
  id              Int      @id @default(autoincrement())
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       Int
  variant         String?
  largeUrl        String
  largeWidth      Int?
  largeHeight     Int?
  thumbnailUrl    String?
  thumbnailWidth  Int?
  thumbnailHeight Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ProductClassifier {
  id          Int      @id @default(autoincrement())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   Int
  name        String
  imageUrl    String?
  isImportant Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Discount {
  id                         Int            @id
  product                    Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId                  Int            @unique
  isDiscounted               Boolean        @default(false)
  source                     DiscountSource @default(UNKNOWN)
  undiscountedGrossPrice     Decimal?       @db.Decimal(10, 2)
  undiscountedGrossUnitPrice Decimal?       @db.Decimal(10, 2)
  descriptionShort           String?
  maximumQuantity            Int?
  remainingQuantity          Int?
  activeUntil                DateTime?
  hasRelatedDiscountProducts Boolean?       @default(false)
  isSilent                   Boolean?       @default(false)
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
}

model Promotion {
  id                Int                   @id @default(autoincrement())
  product           Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId         Int
  title             String
  descriptionShort  String?
  accessibilityText String?
  displayStyle      PromotionDisplayStyle @default(UNKNOWN)
  isPrimary         Boolean               @default(false)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}
