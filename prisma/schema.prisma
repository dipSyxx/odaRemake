generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

//
// enum-Ð¸
//
enum CartStatus {
  DRAFT
  ACTIVE
  SUBMITTED
  CANCELLED
}

enum DiscountSource {
  CAMPAIGN
  UNKNOWN
}

enum PromotionDisplayStyle {
  REGULAR_DISCOUNT
  IS_NEW
  MIX_AND_MATCH
  UNKNOWN
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

//
// USER
//
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String?
  phone        String? @unique
  address      String?
  passwordHash String?
  isAdmin      Boolean @default(false)

  carts  Cart[]
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// CATEGORY
//
model Category {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String?
  imageUrl    String?

  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  products ProductCategory[]
  banners  CategoryBanner[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Product   Product[]
}

model CategoryBanner {
  id             String                 @id @default(cuid())
  categoryId     String?
  category       Category?              @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  title          String?
  imageUrl       String?
  targetUri      String?
  promotionTitle String?
  promotionStyle PromotionDisplayStyle?
  isSponsor      Boolean?               @default(false)
  sortOrder      Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// PRODUCT
//
model Product {
  id          String  @id @default(cuid())
  fullName    String
  brand       String?
  brandId     Int?
  name        String
  nameExtra   String?
  frontUrl    String
  absoluteUrl String

  grossPrice                    Decimal @db.Decimal(10, 2)
  grossUnitPrice                Decimal @db.Decimal(10, 2)
  unitPriceQuantityAbbreviation String?
  unitPriceQuantityName         String?
  currency                      String  @default("NOK")

  isAvailable                  Boolean @default(true)
  availabilityCode             String  @default("available")
  availabilityDescription      String?
  availabilityDescriptionShort String?

  metadata                        Json?
  isExemptFromThirdPartyMarketing Boolean @default(false)
  bonusInfo                       Json?

  categories        ProductCategory[]
  primaryCategoryId String?
  primaryCategory   Category?         @relation(fields: [primaryCategoryId], references: [id], onDelete: SetNull)

  images      ProductImage[]
  classifiers ProductClassifier[]
  discount    Discount?
  promotions  Promotion[]

  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductCategory {
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  sortOrder  Int?

  @@id([productId, categoryId])
}

model ProductImage {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant         String?
  largeUrl        String
  largeWidth      Int?
  largeHeight     Int?
  thumbnailUrl    String?
  thumbnailWidth  Int?
  thumbnailHeight Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ProductClassifier {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String
  imageUrl    String?
  isImportant Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Discount {
  id                         String         @id @default(cuid())
  productId                  String         @unique
  product                    Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  isDiscounted               Boolean        @default(false)
  source                     DiscountSource @default(UNKNOWN)
  undiscountedGrossPrice     Decimal?       @db.Decimal(10, 2)
  undiscountedGrossUnitPrice Decimal?       @db.Decimal(10, 2)
  descriptionShort           String?
  maximumQuantity            Int?
  remainingQuantity          Int?
  activeUntil                DateTime?
  hasRelatedDiscountProducts Boolean?       @default(false)
  isSilent                   Boolean?       @default(false)
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
}

model Promotion {
  id                String                @id @default(cuid())
  productId         String
  product           Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  title             String
  descriptionShort  String?
  accessibilityText String?
  displayStyle      PromotionDisplayStyle @default(UNKNOWN)
  isPrimary         Boolean               @default(false)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}

//
// CART
//
model Cart {
  id          String     @id @default(cuid())
  userId      String?
  user        User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  status      CartStatus @default(DRAFT)
  currency    String     @default("NOK")
  totalAmount Decimal    @default(0) @db.Decimal(12, 2)
  items       CartItem[]
  order       Order?

  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  unitPrice Decimal  @db.Decimal(10, 2)
  currency  String   @default("NOK")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
}

//
// ORDER
//
model Order {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  cartId String? @unique
  cart   Cart?   @relation(fields: [cartId], references: [id], onDelete: SetNull)

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  currency      String  @default("NOK")
  subtotal      Decimal @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  shippingTotal Decimal @default(0) @db.Decimal(12, 2)
  total         Decimal @db.Decimal(12, 2)

  shippingAddress String?
  billingAddress  String?

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  productName String
  unitPrice   Decimal @db.Decimal(10, 2)
  quantity    Int     @default(1)
  currency    String  @default("NOK")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
}
